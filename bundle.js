(()=>{"use strict";window.utils={getRandomIndex:e=>Math.floor(Math.random()*e),getRandomInt:(e=15,t=200)=>Math.floor(Math.random()*(t-e+1))+e,isEscapeEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isElementOutclicked:(e,t,n)=>{e.target===t&&n()},higlightElement:(e,t)=>{e.style=`outline: ${t}; box-shadow: 0 0 0 3px ${t}`},resetElementStyles:e=>{e.style=null},removeAllEventListeners:e=>{e.replaceWith(e.cloneNode(!0))}},window.debounce=e=>{let t=null;return n=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(n)}),500)}},(()=>{const e=["Всё отлично!","В целом всё неплохо. Но не всё.","Когда вы делаете фотографию, хорошо бы убирать палец из кадра. В конце концов это просто непрофессионально.","Моя бабушка случайно чихнула с фотоаппаратом в руках и у неё получилась фотография лучше.","Я поскользнулся на банановой кожуре и уронил фотоаппарат на кота и у меня получилась фотография лучше.","Лица у людей на фотке перекошены, как будто их избивают. Как можно было поймать такой неудачный момент?!"],t=["Саша","Маша","Даша","Паша","Коля","Оля","Алексей"],n=()=>{const n={};return n.avatar=`img/avatar-${window.utils.getRandomInt(1,6)}.svg`,n.message=e[window.utils.getRandomIndex(e.length)],n.name=t[window.utils.getRandomIndex(t.length)],n},r=e=>{const t={};t.url=`photos/${e}.jpg`,t.description="Photo "+e,t.likes=window.utils.getRandomInt(),t.comments=[];for(let e=0;e<window.utils.getRandomInt(1,5);e++)t.comments.push(n());return t};window.data={createPicturesList:(e=25)=>{const t=[];for(let n=1;n<=e;n++)t.push(r(n));return t}}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__button"),r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=r.querySelector(".error__title"),i=r.querySelector(".error__button"),l=()=>{c()},s=e=>{window.utils.isEscapeEvent(e,c)},d=e=>{window.utils.isElementOutclicked(e,t,c)},c=()=>{e.removeChild(t),n.removeEventListener("click",l),document.removeEventListener("keydown",s),document.removeEventListener("click",d)},a=()=>{w()},u=e=>{window.utils.isEscapeEvent(e,w)},m=e=>{window.utils.isElementOutclicked(e,r,w)},w=()=>{e.removeChild(r),i.removeEventListener("click",a),document.removeEventListener("keydown",u),document.removeEventListener("click",m)};window.alert={renderAlert:e=>{const t=document.querySelector("main"),n=document.createElement("div"),r=document.createElement("p");n.style="position: absolute; z-index: 5; top: 0; left: 0; right: 0; background-color: red; display: flex; justify-content: center; align-items: center",r.style="color: white",r.textContent=e,n.appendChild(r),t.appendChild(n),setTimeout((()=>{t.removeChild(n)}),5e3)},renderSuccessAlert:()=>{e.appendChild(t),n.addEventListener("click",l),document.addEventListener("keydown",s),document.addEventListener("click",d)},renderErrorAlert:t=>{o.textContent=t,e.appendChild(r),i.addEventListener("click",a),document.addEventListener("keydown",u),document.addEventListener("click",m)}}})(),(()=>{const e=document.querySelector(".img-filters__form");let t=0;const n=window.debounce((e=>{switch(e){case"filter-default":window.gallery.renderPicturesList(window.loadedData);break;case"filter-random":window.gallery.renderPicturesList((()=>{const e=JSON.parse(JSON.stringify(window.loadedData)),t=[];for(let n=0;n<10;n++)t.push(e.splice(window.utils.getRandomIndex(e.length),1)[0]);return t})());break;case"filter-discussed":window.gallery.renderPicturesList(JSON.parse(JSON.stringify(window.loadedData)).sort(((e,t)=>t.comments.length-e.comments.length)))}}));window.filters={filtersClickHandler:r=>{e.children[t].classList.remove("img-filters__button--active"),r.target.classList.add("img-filters__button--active"),t=Array.from(r.target.parentNode.children).indexOf(r.target),n(r.target.id)}}})(),(()=>{const e=(e,t,n,r)=>{e.responseType="json",e.addEventListener("load",(()=>{let r;switch(e.status){case 200:t(e.response);break;case 400:r="Неверный запрос";break;case 401:r="Пользователь не авторизован";break;case 404:r="Ничего не найдено";break;default:r=`Статус ответа: ${e.status} ${e.statusText}`}r&&n(r)})),e.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),e.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${r}мс`)})),e.timeout=r};window.backend={loadPhotos:(t,n)=>{const r=new XMLHttpRequest;e(r,t,n,1e4),r.open("GET","https://21.javascript.pages.academy/kekstagram/data"),r.send()},uploadPhoto:(t,n,r)=>{const o=new XMLHttpRequest;e(o,n,r,1e4),o.open("POST","https://21.javascript.pages.academy/kekstagram"),o.send(t)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.picture={renderPictureElement:t=>{const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n.addEventListener("click",window.preview.onPreviewClickHandler.bind(null,t)),n}}})(),(()=>{const e=document.querySelector(".pictures");window.gallery={renderPicturesList:t=>{for(;e.children.length>2;)e.removeChild(e.lastChild);const n=document.createDocumentFragment();for(let e of t)n.appendChild(window.picture.renderPictureElement(e));e.appendChild(n)}}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector(".big-picture"),n=t.querySelector(".big-picture__cancel"),r=t.querySelector(".big-picture__img img"),o=t.querySelector(".likes-count"),i=t.querySelector(".comments-count"),l=t.querySelector(".displayed-comments"),s=t.querySelector(".social__comments"),d=t.querySelector(".social__caption");let c=t.querySelector(".comments-loader");const a=e=>{const t=document.createElement("li"),n=document.createElement("img"),r=document.createElement("p");return n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name,n.width="35",n.height="35",r.classList.add("social__text"),r.textContent=e.message,t.classList.add("social__comment"),t.appendChild(n),t.appendChild(r),t},u=e=>{const t=document.createDocumentFragment();if(e.length<5)for(let n of e)t.appendChild(a(n)),c.classList.add("hidden");else for(let n=0;n<5;n++)t.appendChild(a(e.shift()));s.appendChild(t),l.textContent=s.children.length},m=e=>{u(e)},w=e=>{(()=>{for(;s.firstChild;)s.removeChild(s.firstChild)})(),c.classList.contains("hidden")&&c.classList.remove("hidden"),window.utils.removeAllEventListeners(c),c=t.querySelector(".comments-loader"),c.addEventListener("click",m.bind(null,e)),u(e)},v=e=>{e.notDisplayedComments=JSON.parse(JSON.stringify(e.comments)),r.src=e.url,o.textContent=e.likes,i.textContent=e.comments.length,w(e.notDisplayedComments),d.textContent=e.description},p=()=>{e.classList.remove("modal-open"),t.classList.add("hidden"),n.removeEventListener("click",p),document.removeEventListener("keydown",f)},f=e=>{"Escape"===e.key&&(e.preventDefault(),p())};window.preview={renderPictureDetailsElement:v,onPreviewClickHandler:r=>{v(r),e.classList.add("modal-open"),t.classList.remove("hidden"),n.addEventListener("click",p),document.addEventListener("keydown",f)}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__line"),n=e.querySelector(".effect-level__pin");window.slider={pinMouseDownHandler:e=>{e.preventDefault();let r=e.clientX;const o=e=>{e.preventDefault();let o=r-e.clientX;r=e.clientX,window.form.setEffectLevel((e=>{const r=(100*(n.offsetLeft-e)/t.offsetWidth).toFixed(0);return r>100?r=100:r<0&&(r=0),r})(o))},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t="rgba(255, 0, 0, .5)",n=/^#[A-Za-z0-9]{1,19}$/,r={"effects__preview--chrome":e=>`grayscale(${e/100})`,"effects__preview--sepia":e=>`sepia(${e/100})`,"effects__preview--marvin":e=>`invert(${e}%)`,"effects__preview--phobos":e=>`blur(${3*e/100}px)`,"effects__preview--heat":e=>`brightness(${2*e/100+1})`};let o=100,i=100,l="";const s=document.querySelector("body"),d=document.querySelector(".img-upload__form"),c=d.querySelector("#upload-file"),a=d.querySelector("#upload-cancel"),u=d.querySelector(".img-upload__overlay"),m=u.querySelector(".img-upload__preview img"),w=u.querySelector(".scale__control--smaller"),v=u.querySelector(".scale__control--bigger"),p=u.querySelector(".scale__control--value"),f=u.querySelector(".effects__list"),y=f.querySelector("#effect-none"),h=u.querySelector(".img-upload__effect-level"),g=h.querySelector(".effect-level__value"),L=h.querySelector(".effect-level__pin"),E=h.querySelector(".effect-level__depth"),_=u.querySelector(".text__hashtags"),S=u.querySelector(".text__description"),k=()=>{u.classList.add("hidden"),s.classList.remove("modal-open"),c.value="",window.utils.resetElementStyles(_),a.removeEventListener("click",k),w.removeEventListener("click",C),v.removeEventListener("click",b),f.removeEventListener("change",P),L.removeEventListener("mousedown",window.slider.pinMouseDownHandler),_.removeEventListener("input",A),d.removeEventListener("submit",M),document.removeEventListener("keydown",R)},q=e=>{p.value=e+"%",m.style.transform=`scale(${e/100})`},C=()=>{o>25&&(o-=25,q(o))},b=()=>{o<100&&(o+=25,q(o))},x=e=>{g.value=e,L.style.left=e+"%",E.style.width=e+"%",m.style.filter=r[l](e)},D=()=>{""!==l&&(m.style.filter=null,m.classList.remove(l))},P=e=>{D(),"none"!==e.target.value?(l="effects__preview--"+e.target.value,m.classList.add(l),i=100,x(i)):l="",""!==l?h.classList.remove("hidden"):h.classList.add("hidden")},$=(e,t)=>e.filter((e=>e.toLowerCase()===t)).length,A=()=>{const e=_.value.split(" ");0===_.value.length?(_.setCustomValidity(""),window.utils.resetElementStyles(_)):(e=>e.length<=5)(e)?(e=>{for(let t of e)if(!n.test(t))return!1;return!0})(e)?(e=>{for(let t of e)if($(e,t.toLowerCase())>1)return!1;return!0})(e)?(_.setCustomValidity(""),window.utils.resetElementStyles(_)):(_.setCustomValidity("Хэштеги не должны повторяться"),window.utils.higlightElement(_,t)):(_.setCustomValidity("Хэштег должен начинаться с символа #, может включать только буквы и цифры, а также не превышать 20 символов в длину"),window.utils.higlightElement(_,t)):(_.setCustomValidity("Количество хэштегов не должно превышать 5. Пожалуйста, удалите "+(e.length-5)),window.utils.higlightElement(_,t)),_.reportValidity()},R=e=>{"Escape"===e.key&&(e.preventDefault(),_!==document.activeElement&&S!==document.activeElement&&k())},N=()=>{_.value="",S.value=""},O=()=>{k(),N(),window.alert.renderSuccessAlert()},H=e=>{k(),N(),window.alert.renderErrorAlert(e)},M=e=>{window.backend.uploadPhoto(new FormData(d),O,H),e.preventDefault()};c.addEventListener("change",(t=>{const n=t.target.files[0];(t=>{const n=t.name.toLowerCase();return e.some((e=>n.endsWith(e)))})(n)?(u.classList.remove("hidden"),s.classList.add("modal-open"),(e=>{const t=new FileReader;t.addEventListener("load",(()=>{m.src=t.result})),t.readAsDataURL(e)})(n),o=100,q(o),h.classList.add("hidden"),y.checked=!0,D(),a.addEventListener("click",k),w.addEventListener("click",C),v.addEventListener("click",b),f.addEventListener("change",P),L.addEventListener("mousedown",window.slider.pinMouseDownHandler),_.addEventListener("input",A),d.addEventListener("submit",M),document.addEventListener("keydown",R)):(window.alert.renderAlert("Неправильный формат изображения!"),d.reset())})),window.form={setEffectLevel:x}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form");window.backend.loadPhotos((n=>{window.loadedData=n,window.gallery.renderPicturesList(n),t.addEventListener("click",window.filters.filtersClickHandler),e.classList.remove("img-filters--inactive")}),window.alert.renderAlert)})()})();