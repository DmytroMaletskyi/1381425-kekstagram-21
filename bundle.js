(()=>{"use strict";window.utils={getRandomIndex:e=>Math.floor(Math.random()*e),getRandomInt:(e=15,t=200)=>Math.floor(Math.random()*(t-e+1))+e,isEscapeEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},isElementOutClicked:(e,t,n)=>{e.target===t&&n()},higlightElement:(e,t)=>{e.style=`outline: ${t}; box-shadow: 0 0 0 3px ${t}`},resetElementStyles:e=>{e.style=null},removeAllEventListeners:e=>{e.replaceWith(e.cloneNode(!0))}},window.debounce=e=>{let t=null;return n=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(n)}),500)}},(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),n=t.querySelector(".success__button"),r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),o=r.querySelector(".error__title"),i=r.querySelector(".error__button"),l=()=>{c()},s=e=>{window.utils.isEscapeEvent(e,c)},d=e=>{window.utils.isElementOutClicked(e,t,c)},c=()=>{e.removeChild(t),n.removeEventListener("click",l),document.removeEventListener("keydown",s),document.removeEventListener("click",d)},a=()=>{v()},u=e=>{window.utils.isEscapeEvent(e,v)},m=e=>{window.utils.isElementOutClicked(e,r,v)},v=()=>{e.removeChild(r),i.removeEventListener("click",a),document.removeEventListener("keydown",u),document.removeEventListener("click",m)};window.alertsRendering={renderAlert:t=>{const n=document.createElement("div"),r=document.createElement("p");n.style="position: absolute; z-index: 5; top: 0; left: 0; right: 0; background-color: red; display: flex; justify-content: center; align-items: center",r.style="color: white",r.textContent=t,n.appendChild(r),e.appendChild(n),setTimeout((()=>{e.removeChild(n)}),5e3)},renderSuccessAlert:()=>{e.appendChild(t),n.addEventListener("click",l),document.addEventListener("keydown",s),document.addEventListener("click",d)},renderErrorAlert:t=>{o.textContent=t,e.appendChild(r),i.addEventListener("click",a),document.addEventListener("keydown",u),document.addEventListener("click",m)}}})(),(()=>{const e="filter-default",t="filter-random",n="filter-discussed",r=document.querySelector(".img-filters__form");let o=0;const i=window.debounce((r=>{switch(r){case e:window.gallery.renderPicturesList(window.loadedPicturesData);break;case t:window.gallery.renderPicturesList((()=>{const e=JSON.parse(JSON.stringify(window.loadedPicturesData)),t=[];for(let n=0;n<10;n++)t.push(e.splice(window.utils.getRandomIndex(e.length),1)[0]);return t})());break;case n:window.gallery.renderPicturesList(JSON.parse(JSON.stringify(window.loadedPicturesData)).sort(((e,t)=>t.comments.length-e.comments.length)))}}));window.filters={сlickHandler:e=>{r.children[o].classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active"),o=Array.from(e.target.parentNode.children).indexOf(e.target),i(e.target.id)}}})(),(()=>{const e=200,t=400,n=401,r=404,o=(o,i,l,s,d)=>{const c=new XMLHttpRequest;return((o,i,l,s)=>{o.responseType="json",o.addEventListener("load",(()=>{let s;switch(o.status){case e:i(o.response);break;case t:s="Неверный запрос";break;case n:s="Пользователь не авторизован";break;case r:s="Ничего не найдено";break;default:s=`Статус ответа: ${o.status} ${o.statusText}`}s&&l(s)})),o.addEventListener("error",(()=>{l("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{l(`Запрос не успел выполниться за ${s}мс`)})),o.timeout=s})(c,l,s,d),c.open(i,o),c};window.backend={loadPhotos:(e,t)=>{o("https://21.javascript.pages.academy/kekstagram/data","GET",e,t,1e4).send()},uploadPhoto:(e,t,n)=>{o("https://21.javascript.pages.academy/kekstagram","POST",t,n,1e4).send(e)}}})(),(()=>{const e=document.querySelector("#picture").content.querySelector(".picture");window.picture={renderElement:t=>{const n=e.cloneNode(!0);return n.querySelector(".picture__img").src=t.url,n.querySelector(".picture__likes").textContent=t.likes,n.querySelector(".picture__comments").textContent=t.comments.length,n.addEventListener("click",window.preview.сlickHandler.bind(null,t)),n}}})(),(()=>{const e=document.querySelector(".pictures");window.gallery={renderPicturesList:t=>{for(;e.children.length>2;)e.removeChild(e.lastChild);const n=document.createDocumentFragment();for(let e of t)n.appendChild(window.picture.renderElement(e));e.appendChild(n)}}})(),(()=>{const e=document.querySelector("body"),t=document.querySelector(".big-picture"),n=t.querySelector(".big-picture__cancel"),r=t.querySelector(".big-picture__img img"),o=t.querySelector(".likes-count"),i=t.querySelector(".comments-count"),l=t.querySelector(".displayed-comments"),s=t.querySelector(".social__comments"),d=t.querySelector(".social__caption");let c=t.querySelector(".comments-loader");const a=e=>{const t=document.createElement("li"),n=document.createElement("img"),r=document.createElement("p");return n.classList.add("social__picture"),n.src=e.avatar,n.alt=e.name,n.width="35",n.height="35",r.classList.add("social__text"),r.textContent=e.message,t.classList.add("social__comment"),t.appendChild(n),t.appendChild(r),t},u=e=>{const t=document.createDocumentFragment();if(e.length<=5)for(let n of e)t.appendChild(a(n)),c.classList.add("hidden");else for(let n=0;n<5;n++)t.appendChild(a(e.shift()));s.appendChild(t),l.textContent=s.children.length},m=e=>{u(e)},v=e=>{s.innerHTML="",c.classList.contains("hidden")&&c.classList.remove("hidden"),window.utils.removeAllEventListeners(c),c=t.querySelector(".comments-loader"),c.addEventListener("click",m.bind(null,e)),u(e)},w=e=>{e.notDisplayedComments=JSON.parse(JSON.stringify(e.comments)),r.src=e.url,o.textContent=e.likes,i.textContent=e.comments.length,v(e.notDisplayedComments),d.textContent=e.description},p=()=>{e.classList.remove("modal-open"),t.classList.add("hidden"),n.removeEventListener("click",p),document.removeEventListener("keydown",y)},y=e=>{"Escape"===e.key&&(e.preventDefault(),p())};window.preview={renderPictureDetailsElement:w,сlickHandler:r=>{w(r),e.classList.add("modal-open"),t.classList.remove("hidden"),n.addEventListener("click",p),document.addEventListener("keydown",y)}}})(),(()=>{const e=document.querySelector(".img-upload__effect-level"),t=e.querySelector(".effect-level__line"),n=e.querySelector(".effect-level__pin");window.slider={pinMouseDownHandler:e=>{e.preventDefault();let r=e.clientX;const o=e=>{e.preventDefault();let o=r-e.clientX;r=e.clientX,window.form.setEffectLevel((e=>{let r=(100*(n.offsetLeft-e)/t.offsetWidth).toFixed(0);return r>100?r=100:r<0&&(r=0),r})(o))},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",i)}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t="rgba(255, 0, 0, .5)",n=/^#[A-Za-z0-9]{1,19}$/,r={"effects__preview--chrome":e=>`grayscale(${e/100})`,"effects__preview--sepia":e=>`sepia(${e/100})`,"effects__preview--marvin":e=>`invert(${e}%)`,"effects__preview--phobos":e=>`blur(${3*e/100}px)`,"effects__preview--heat":e=>`brightness(${2*e/100+1})`};let o=100,i=100,l="";const s=document.querySelector("body"),d=document.querySelector(".img-upload__form"),c=d.querySelector("#upload-file"),a=d.querySelector("#upload-cancel"),u=d.querySelector(".img-upload__overlay"),m=u.querySelector(".img-upload__preview img"),v=u.querySelector(".scale__control--smaller"),w=u.querySelector(".scale__control--bigger"),p=u.querySelector(".scale__control--value"),y=u.querySelector(".effects__list"),f=y.querySelector("#effect-none"),g=u.querySelector(".img-upload__effect-level"),h=g.querySelector(".effect-level__value"),L=g.querySelector(".effect-level__pin"),E=g.querySelector(".effect-level__depth"),_=u.querySelector(".text__hashtags"),S=u.querySelector(".text__description"),k=()=>{u.classList.add("hidden"),s.classList.remove("modal-open"),d.reset(),window.utils.resetElementStyles(_),a.removeEventListener("click",k),v.removeEventListener("click",C),w.removeEventListener("click",b),y.removeEventListener("change",P),L.removeEventListener("mousedown",window.slider.pinMouseDownHandler),_.removeEventListener("input",$),d.removeEventListener("submit",M),document.removeEventListener("keydown",N)},q=e=>{p.value=e+"%",m.style.transform=`scale(${e/100})`},C=()=>{o>25&&(o-=25,q(o))},b=()=>{o<100&&(o+=25,q(o))},x=e=>{h.value=e,L.style.left=e+"%",E.style.width=e+"%",m.style.filter=r[l](e)},D=()=>{""!==l&&(m.style.filter=null,m.classList.remove(l))},P=e=>{D(),"none"!==e.target.value?(l="effects__preview--"+e.target.value,m.classList.add(l),i=100,x(i)):l="",""!==l?g.classList.remove("hidden"):g.classList.add("hidden")},A=(e,t)=>e.filter((e=>e.toLowerCase()===t)).length,$=()=>{const e=_.value.split(" ");0===_.value.length?(_.setCustomValidity(""),window.utils.resetElementStyles(_)):(e=>e.length<=5)(e)?(e=>{for(let t of e)if(!n.test(t))return!1;return!0})(e)?(e=>{for(let t of e)if(A(e,t.toLowerCase())>1)return!1;return!0})(e)?(_.setCustomValidity(""),window.utils.resetElementStyles(_)):(_.setCustomValidity("Хэштеги не должны повторяться"),window.utils.higlightElement(_,t)):(_.setCustomValidity("Хэштег должен начинаться с символа #, может включать только буквы и цифры, а также не превышать 20 символов в длину"),window.utils.higlightElement(_,t)):(_.setCustomValidity("Количество хэштегов не должно превышать 5. Пожалуйста, удалите "+(e.length-5)),window.utils.higlightElement(_,t)),_.reportValidity()},N=e=>{"Escape"===e.key&&(e.preventDefault(),_!==document.activeElement&&S!==document.activeElement&&k())},O=()=>{_.value="",S.value=""},R=()=>{k(),O(),window.alertsRendering.renderSuccessAlert()},H=e=>{k(),O(),window.alertsRendering.renderErrorAlert(e)},M=e=>{window.backend.uploadPhoto(new FormData(d),R,H),e.preventDefault()};c.addEventListener("change",(t=>{const n=t.target.files[0];(t=>{const n=t.name.toLowerCase();return e.some((e=>n.endsWith(e)))})(n)?(u.classList.remove("hidden"),s.classList.add("modal-open"),(e=>{const t=new FileReader;t.addEventListener("load",(()=>{m.src=t.result})),t.readAsDataURL(e)})(n),o=100,q(o),g.classList.add("hidden"),f.checked=!0,D(),a.addEventListener("click",k),v.addEventListener("click",C),w.addEventListener("click",b),y.addEventListener("change",P),L.addEventListener("mousedown",window.slider.pinMouseDownHandler),_.addEventListener("input",$),d.addEventListener("submit",M),document.addEventListener("keydown",N)):(window.alertsRendering.renderAlert("Неправильный формат изображения!"),d.reset())})),window.form={setEffectLevel:x}})(),(()=>{const e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form");window.backend.loadPhotos((n=>{window.loadedPicturesData=n,window.gallery.renderPicturesList(n),t.addEventListener("click",window.filters.сlickHandler),e.classList.remove("img-filters--inactive")}),window.alertsRendering.renderAlert)})()})();